<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¢è«‡ã‚«ãƒ«ãƒ†å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  - Interview Karte Webform</title>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/@pdf-lib/fontkit@1.0.0/dist/fontkit.umd.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            font-size: 16px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header .subtitle {
            font-size: 16px;
            opacity: 0.95;
        }

        .campus-info {
            background: #f8f9fa;
            padding: 15px 30px;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .campus-info .label {
            font-weight: bold;
            color: #495057;
        }

        .campus-info .value {
            background: white;
            padding: 8px 16px;
            border-radius: 6px;
            border: 2px solid #667eea;
            color: #667eea;
            font-weight: bold;
        }

        .form-content {
            padding: 30px;
        }

        .section {
            margin-bottom: 35px;
        }

        .section-title {
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title::before {
            content: "â–¶";
            font-size: 16px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #212529;
            font-size: 15px;
        }

        .required::after {
            content: " *";
            color: #dc3545;
            font-weight: bold;
        }

        input[type="text"],
        input[type="date"],
        input[type="email"],
        input[type="tel"],
        select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #ced4da;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            transition: all 0.3s ease;
            min-height: 48px;
        }

        input[type="text"]:focus,
        input[type="date"]:focus,
        input[type="email"]:focus,
        input[type="tel"]:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        input:disabled {
            background-color: #e9ecef;
            cursor: not-allowed;
        }

        .help-text {
            font-size: 13px;
            color: #6c757d;
            margin-top: 5px;
        }

        .error-message {
            color: #dc3545;
            font-size: 14px;
            margin-top: 5px;
            display: none;
            font-weight: 500;
        }

        .form-group.error input,
        .form-group.error select {
            border-color: #dc3545;
            background-color: #fff5f5;
        }

        .form-group.error .error-message {
            display: block;
        }

        .form-group.valid input,
        .form-group.valid select {
            border-color: #28a745;
        }

        .submit-section {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #e9ecef;
        }

        .submit-button {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            min-height: 56px;
        }

        .submit-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .submit-button:active {
            transform: translateY(0);
        }

        .handoff-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .handoff-modal.show {
            display: flex;
        }

        .handoff-content {
            background: white;
            padding: 50px;
            border-radius: 16px;
            text-align: center;
            max-width: 600px;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .handoff-content .icon {
            font-size: 80px;
            margin-bottom: 20px;
        }

        .handoff-content h2 {
            font-size: 28px;
            color: #212529;
            margin-bottom: 15px;
        }

        .handoff-content p {
            font-size: 20px;
            color: #495057;
            line-height: 1.6;
        }

        .proceed-button {
            margin-top: 30px;
            padding: 16px 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .proceed-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .proceed-button:active {
            transform: translateY(0);
        }

        .instruction-box {
            background: #e7f3ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 25px;
            border-radius: 4px;
        }

        .instruction-box p {
            color: #495057;
            font-size: 14px;
            line-height: 1.6;
        }

        /* Success Modal Styles */
        .success-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1002;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .success-modal.show {
            display: flex;
        }

        .success-content {
            background: white;
            padding: 50px;
            border-radius: 16px;
            text-align: center;
            max-width: 500px;
            animation: slideUp 0.3s ease;
        }

        .success-content .icon {
            font-size: 100px;
            margin-bottom: 20px;
            animation: scaleIn 0.5s ease;
        }

        @keyframes scaleIn {
            from {
                transform: scale(0);
            }
            to {
                transform: scale(1);
            }
        }

        .success-content h2 {
            font-size: 28px;
            color: #28a745;
            margin-bottom: 15px;
        }

        .success-content p {
            font-size: 18px;
            color: #495057;
            line-height: 1.6;
        }

        /* PDF Format Selection Modal */
        .pdf-format-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1003;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .pdf-format-modal.show {
            display: flex;
        }

        .pdf-format-content {
            background: white;
            padding: 40px;
            border-radius: 16px;
            max-width: 700px;
            width: 100%;
            animation: slideUp 0.3s ease;
        }

        .pdf-format-header {
            text-align: center;
            margin-bottom: 35px;
        }

        .pdf-format-header .icon {
            font-size: 60px;
            margin-bottom: 15px;
        }

        .pdf-format-header h2 {
            font-size: 26px;
            color: #212529;
            margin-bottom: 10px;
        }

        .pdf-format-header .subtitle {
            font-size: 16px;
            color: #6c757d;
        }

        .format-options {
            display: grid;
            gap: 20px;
            margin-bottom: 30px;
        }

        .format-card {
            background: white;
            border: 3px solid #e9ecef;
            border-radius: 12px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .format-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
        }

        .format-card.selected {
            border-color: #667eea;
            background: #f0f4ff;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .format-card .icon {
            font-size: 48px;
            min-width: 60px;
            text-align: center;
        }

        .format-card .details {
            flex: 1;
        }

        .format-card .format-title {
            font-size: 20px;
            font-weight: bold;
            color: #212529;
            margin-bottom: 5px;
        }

        .format-card .format-description {
            font-size: 14px;
            color: #6c757d;
        }

        .format-card .checkmark {
            font-size: 32px;
            color: #667eea;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .format-card.selected .checkmark {
            opacity: 1;
        }

        .pdf-actions {
            display: flex;
            gap: 15px;
            padding-top: 20px;
            border-top: 2px solid #e9ecef;
        }

        .pdf-actions button {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        /* PDF Preview Modal */
        .pdf-preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1004;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .pdf-preview-modal.show {
            display: flex;
        }

        .pdf-preview-content {
            background: white;
            padding: 40px;
            border-radius: 16px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        .pdf-preview-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .pdf-preview-header .icon {
            font-size: 60px;
            margin-bottom: 15px;
        }

        .pdf-preview-header h2 {
            font-size: 26px;
            color: #212529;
            margin-bottom: 10px;
        }

        .data-mapping {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .data-mapping-title {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 15px;
        }

        .data-field {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 15px;
            padding: 10px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .data-field:last-child {
            border-bottom: none;
        }

        .field-label {
            font-size: 14px;
            color: #6c757d;
            font-weight: 600;
        }

        .field-value {
            font-size: 14px;
            color: #212529;
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 24px;
            }

            .form-content {
                padding: 20px;
            }

            .duplicate-sections-container {
                grid-template-columns: 1fr;
            }

            .duplicate-content {
                max-width: 100%;
            }
        }

        /* Touch-friendly adjustments for tablets */
        @media (hover: none) and (pointer: coarse) {
            input, select, button {
                font-size: 16px; /* Prevents zoom on iOS */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>é¢è«‡ã‚«ãƒ«ãƒ†å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ </h1>
            <p class="subtitle">Interview Karte Registration Form</p>
        </div>

        <div class="campus-info">
            <span class="label">æ ¡èˆ / Campus:</span>
            <span class="value" id="campusValue">Shibuya</span>
        </div>

        <div class="form-content">
            <div class="instruction-box">
                <p>ğŸ“± ä¿è­·è€…æ§˜ã¸ï¼šä»¥ä¸‹ã®ãƒ•ã‚©ãƒ¼ãƒ ã«ã”è¨˜å…¥ãã ã•ã„ã€‚å…¨ã¦ã®å¿…é ˆé …ç›®ï¼ˆ*å°ï¼‰ã«ã”å…¥åŠ›ã„ãŸã ãã€å…¥åŠ›ãŒå®Œäº†ã—ã¾ã—ãŸã‚‰ã€Œé€ä¿¡ã™ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>
                <p style="margin-top: 8px;"><strong>For Parents:</strong> Please fill out the form below. Complete all required fields (marked with *) and click "Submit" when finished.</p>
            </div>

            <form id="interviewForm">
                <!-- Student Information Section -->
                <div class="section">
                    <div class="section-title">ç”Ÿå¾’æƒ…å ± / Student Information</div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="studentLastName" class="required">å§“ / Last Name</label>
                            <input type="text" id="studentLastName" name="studentLastName" placeholder="ä¾‹: å±±ç”°">
                            <span class="error-message"></span>
                        </div>
                        <div class="form-group">
                            <label for="studentFirstName" class="required">å / First Name</label>
                            <input type="text" id="studentFirstName" name="studentFirstName" placeholder="ä¾‹: å¤ªéƒ">
                            <span class="error-message"></span>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="studentLastNameKana" class="required">å§“ï¼ˆãƒ•ãƒªã‚¬ãƒŠï¼‰/ Last Name (Katakana)</label>
                            <input type="text" id="studentLastNameKana" name="studentLastNameKana" placeholder="ä¾‹: ãƒ¤ãƒãƒ€">
                            <span class="help-text">å…¨è§’ã‚«ã‚¿ã‚«ãƒŠã§å…¥åŠ›ã—ã¦ãã ã•ã„ / Enter in full-width katakana</span>
                            <span class="error-message"></span>
                        </div>
                        <div class="form-group">
                            <label for="studentFirstNameKana" class="required">åï¼ˆãƒ•ãƒªã‚¬ãƒŠï¼‰/ First Name (Katakana)</label>
                            <input type="text" id="studentFirstNameKana" name="studentFirstNameKana" placeholder="ä¾‹: ã‚¿ãƒ­ã‚¦">
                            <span class="help-text">å…¨è§’ã‚«ã‚¿ã‚«ãƒŠã§å…¥åŠ›ã—ã¦ãã ã•ã„ / Enter in full-width katakana</span>
                            <span class="error-message"></span>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="studentBirthdate" class="required">ç”Ÿå¹´æœˆæ—¥ / Date of Birth</label>
                            <input type="date" id="studentBirthdate" name="studentBirthdate">
                            <span class="error-message"></span>
                        </div>
                        <div class="form-group">
                            <label for="studentGender">æ€§åˆ¥ / Gender</label>
                            <select id="studentGender" name="studentGender">
                                <option value="">é¸æŠã—ã¦ãã ã•ã„ / Select</option>
                                <option value="male">ç”·æ€§ / Male</option>
                                <option value="female">å¥³æ€§ / Female</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="studentGrade" class="required">å­¦å¹´ / Grade</label>
                            <select id="studentGrade" name="studentGrade">
                                <option value="">é¸æŠã—ã¦ãã ã•ã„ / Select</option>
                                <option value="1">å°å­¦1å¹´ / Grade 1</option>
                                <option value="2">å°å­¦2å¹´ / Grade 2</option>
                                <option value="3">å°å­¦3å¹´ / Grade 3</option>
                                <option value="4">å°å­¦4å¹´ / Grade 4</option>
                                <option value="5">å°å­¦5å¹´ / Grade 5</option>
                                <option value="6">å°å­¦6å¹´ / Grade 6</option>
                                <option value="7">ä¸­å­¦1å¹´ / Grade 7</option>
                                <option value="8">ä¸­å­¦2å¹´ / Grade 8</option>
                                <option value="9">ä¸­å­¦3å¹´ / Grade 9</option>
                                <option value="10">é«˜æ ¡1å¹´ / Grade 10</option>
                                <option value="11">é«˜æ ¡2å¹´ / Grade 11</option>
                                <option value="12">é«˜æ ¡3å¹´ / Grade 12</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="studentSchoolType">åœ¨ç±å­¦æ ¡ç¨®åˆ¥ / School Type</label>
                            <select id="studentSchoolType" name="studentSchoolType">
                                <option value="">é¸æŠã—ã¦ãã ã•ã„ / Select</option>
                                <option value="public">å…¬ç«‹ / Public</option>
                                <option value="private">ç§ç«‹ / Private</option>
                                <option value="national">å›½ç«‹ / National</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="studentSchoolName">åœ¨ç±å­¦æ ¡å / School Name</label>
                        <input type="text" id="studentSchoolName" name="studentSchoolName" placeholder="ä¾‹: æ¸‹è°·åŒºç«‹â—‹â—‹å°å­¦æ ¡">
                    </div>
                </div>

                <!-- Parent Information Section -->
                <div class="section">
                    <div class="section-title">ä¿è­·è€…æƒ…å ± / Parent Information</div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="parentLastName" class="required">å§“ / Last Name</label>
                            <input type="text" id="parentLastName" name="parentLastName" placeholder="ä¾‹: å±±ç”°">
                            <span class="error-message"></span>
                        </div>
                        <div class="form-group">
                            <label for="parentFirstName" class="required">å / First Name</label>
                            <input type="text" id="parentFirstName" name="parentFirstName" placeholder="ä¾‹: èŠ±å­">
                            <span class="error-message"></span>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="parentLastNameKana" class="required">å§“ï¼ˆãƒ•ãƒªã‚¬ãƒŠï¼‰/ Last Name (Katakana)</label>
                            <input type="text" id="parentLastNameKana" name="parentLastNameKana" placeholder="ä¾‹: ãƒ¤ãƒãƒ€">
                            <span class="help-text">å…¨è§’ã‚«ã‚¿ã‚«ãƒŠã§å…¥åŠ›ã—ã¦ãã ã•ã„ / Enter in full-width katakana</span>
                            <span class="error-message"></span>
                        </div>
                        <div class="form-group">
                            <label for="parentFirstNameKana" class="required">åï¼ˆãƒ•ãƒªã‚¬ãƒŠï¼‰/ First Name (Katakana)</label>
                            <input type="text" id="parentFirstNameKana" name="parentFirstNameKana" placeholder="ä¾‹: ãƒãƒŠã‚³">
                            <span class="help-text">å…¨è§’ã‚«ã‚¿ã‚«ãƒŠã§å…¥åŠ›ã—ã¦ãã ã•ã„ / Enter in full-width katakana</span>
                            <span class="error-message"></span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="parentGender">æ€§åˆ¥ / Gender</label>
                        <select id="parentGender" name="parentGender">
                            <option value="">é¸æŠã—ã¦ãã ã•ã„ / Select</option>
                            <option value="male">ç”·æ€§ / Male</option>
                            <option value="female">å¥³æ€§ / Female</option>
                        </select>
                    </div>
                </div>

                <!-- Address and Contact Information Section -->
                <div class="section">
                    <div class="section-title">ä½æ‰€ãƒ»é€£çµ¡å…ˆ / Address & Contact</div>

                    <div class="form-group">
                        <label for="postalCode" class="required">éƒµä¾¿ç•ªå· / Postal Code</label>
                        <input type="text" id="postalCode" name="postalCode" placeholder="ä¾‹: 1234567" maxlength="7">
                        <span class="help-text">ãƒã‚¤ãƒ•ãƒ³ãªã—7æ¡ã®æ•°å­— / 7 digits without hyphen</span>
                        <span class="error-message"></span>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="prefecture">éƒ½é“åºœçœŒ / Prefecture</label>
                            <select id="prefecture" name="prefecture">
                                <option value="">é¸æŠã—ã¦ãã ã•ã„ / Select</option>
                                <option value="tokyo">æ±äº¬éƒ½ / Tokyo</option>
                                <option value="kanagawa">ç¥å¥ˆå·çœŒ / Kanagawa</option>
                                <option value="chiba">åƒè‘‰çœŒ / Chiba</option>
                                <option value="saitama">åŸ¼ç‰çœŒ / Saitama</option>
                                <option value="osaka">å¤§é˜ªåºœ / Osaka</option>
                                <option value="kyoto">äº¬éƒ½åºœ / Kyoto</option>
                                <!-- More prefectures would be added here -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="city">å¸‚åŒºç”ºæ‘ / City</label>
                            <input type="text" id="city" name="city" placeholder="ä¾‹: æ¸‹è°·åŒº">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="street1">ç•ªåœ° / Street Address 1</label>
                        <input type="text" id="street1" name="street1" placeholder="ä¾‹: 1-2-3">
                    </div>

                    <div class="form-group">
                        <label for="street2">å»ºç‰©åãƒ»éƒ¨å±‹ç•ªå· / Building & Room Number</label>
                        <input type="text" id="street2" name="street2" placeholder="ä¾‹: â—‹â—‹ãƒãƒ³ã‚·ãƒ§ãƒ³101å·å®¤">
                    </div>

                    <div class="form-group">
                        <label for="closestStation">æœ€å¯„ã‚Šé§… / Closest Station</label>
                        <input type="text" id="closestStation" name="closestStation" placeholder="ä¾‹: æ¸‹è°·é§…">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="homePhone">è‡ªå®…é›»è©±ç•ªå· / Home Phone</label>
                            <input type="tel" id="homePhone" name="homePhone" placeholder="ä¾‹: 03-1234-5678">
                            <span class="help-text">ãƒã‚¤ãƒ•ãƒ³ä»˜ãã§å…¥åŠ› / Enter with hyphens</span>
                            <span class="error-message"></span>
                        </div>
                        <div class="form-group">
                            <label for="mobilePhone">æºå¸¯é›»è©±ç•ªå· / Mobile Phone</label>
                            <input type="tel" id="mobilePhone" name="mobilePhone" placeholder="ä¾‹: 090-1234-5678">
                            <span class="help-text">ãƒã‚¤ãƒ•ãƒ³ä»˜ãã§å…¥åŠ› / Enter with hyphens</span>
                            <span class="error-message"></span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="email">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ / Email Address</label>
                        <input type="email" id="email" name="email" placeholder="ä¾‹: example@email.com">
                        <span class="error-message"></span>
                    </div>
                </div>

                <!-- Campus (Hidden/Locked) -->
                <input type="hidden" id="campus" name="campus" value="Shibuya">

                <!-- Submit Section -->
                <div class="submit-section">
                    <button type="submit" class="submit-button">
                        é€ä¿¡ã™ã‚‹ / Submit
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Handoff Modal -->
    <div class="handoff-modal" id="handoffModal">
        <div class="handoff-content">
            <div class="icon">âœ…</div>
            <h2>å…¥åŠ›ãŒå®Œäº†ã—ã¾ã—ãŸ</h2>
            <p style="margin-top: 20px; font-size: 24px; font-weight: bold;">
                ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã‚’ã‚¹ã‚¿ãƒƒãƒ•ã«ãŠæ¸¡ã—ãã ã•ã„ã€‚
            </p>
            <p style="margin-top: 15px; color: #6c757d;">
                Input completed. Please hand the tablet to staff.
            </p>
            <button class="proceed-button" id="proceedButton">
                ã‚¹ã‚¿ãƒƒãƒ•ï¼šæ¬¡ã¸é€²ã‚€ / Staff: Proceed
            </button>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="success-modal" id="successModal">
        <div class="success-content">
            <div class="icon">âœ…</div>
            <h2>ç™»éŒ²å®Œäº†ï¼/ Registration Complete!</h2>
            <p>ãƒ‡ãƒ¼ã‚¿ãŒSalesforceã«æ­£å¸¸ã«é€ä¿¡ã•ã‚Œã¾ã—ãŸã€‚<br>
                Data has been successfully sent to Salesforce.</p>
        </div>
    </div>

    <!-- PDF Format Selection Modal -->
    <div class="pdf-format-modal" id="pdfFormatModal">
        <div class="pdf-format-content">
            <div class="pdf-format-header">
                <div class="icon">ğŸ“„</div>
                <h2>é¢è«‡ã‚«ãƒ«ãƒ†å½¢å¼ã‚’é¸æŠ / Select Interview Karte Format</h2>
                <p class="subtitle">ç”Ÿå¾’ã®å­¦å¹´ã«å¿œã˜ãŸé¢è«‡ã‚«ãƒ«ãƒ†ã®PDFå½¢å¼ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚<br>
                    Select the appropriate PDF format based on student's grade level.</p>
            </div>

            <div class="format-options">
                <!-- Elementary Format -->
                <div class="format-card" data-format="elementary">
                    <div class="icon">ğŸ’</div>
                    <div class="details">
                        <div class="format-title">å°å­¦ç”Ÿç”¨ / Elementary School Format</div>
                        <div class="format-description">å°å­¦1å¹´ç”Ÿã€œå°å­¦6å¹´ç”Ÿå‘ã‘ / For Grade 1-6 students</div>
                    </div>
                    <div class="checkmark">âœ“</div>
                </div>

                <!-- Middle School Format -->
                <div class="format-card" data-format="middle">
                    <div class="icon">ğŸ“š</div>
                    <div class="details">
                        <div class="format-title">ä¸­å­¦ç”Ÿç”¨ / Middle School Format</div>
                        <div class="format-description">ä¸­å­¦1å¹´ç”Ÿã€œä¸­å­¦3å¹´ç”Ÿå‘ã‘ / For Grade 7-9 students</div>
                    </div>
                    <div class="checkmark">âœ“</div>
                </div>

                <!-- High School Format -->
                <div class="format-card" data-format="high">
                    <div class="icon">ğŸ“</div>
                    <div class="details">
                        <div class="format-title">é«˜æ ¡ç”Ÿç”¨ / High School Format</div>
                        <div class="format-description">é«˜æ ¡1å¹´ç”Ÿã€œé«˜æ ¡3å¹´ç”Ÿå‘ã‘ / For Grade 10-12 students</div>
                    </div>
                    <div class="checkmark">âœ“</div>
                </div>
            </div>

            <div class="pdf-actions">
                <button type="button" class="btn-cancel" id="cancelPdfFormat">
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ« / Cancel
                </button>
                <button type="button" class="btn-confirm" id="confirmPdfFormat" disabled>
                    PDFã‚’ç”Ÿæˆ / Generate PDF
                </button>
            </div>
        </div>
    </div>

    <!-- PDF Preview Modal -->
    <div class="pdf-preview-modal" id="pdfPreviewModal">
        <div class="pdf-preview-content">
            <div class="pdf-preview-header">
                <div class="icon">ğŸ“‹</div>
                <h2>PDFãƒ‡ãƒ¼ã‚¿ç¢ºèª / PDF Data Preview</h2>
                <p class="subtitle">ä»¥ä¸‹ã®ãƒ‡ãƒ¼ã‚¿ãŒPDFã«å…¥åŠ›ã•ã‚Œã¾ã™ / The following data will be populated in the PDF</p>
            </div>

            <div class="data-mapping">
                <div class="data-mapping-title">ğŸ“š ç”Ÿå¾’æƒ…å ± / Student Information</div>
                <div class="data-field">
                    <div class="field-label">æ ¡èˆå / Campus</div>
                    <div class="field-value" id="preview-campus"></div>
                </div>
                <div class="data-field">
                    <div class="field-label">ç”Ÿå¾’æ°å(ãƒ•ãƒªã‚¬ãƒŠ) / Student Name (Kana)</div>
                    <div class="field-value" id="preview-student-kana"></div>
                </div>
                <div class="data-field">
                    <div class="field-label">ç”Ÿå¾’æ°å / Student Name</div>
                    <div class="field-value" id="preview-student-name"></div>
                </div>
                <div class="data-field">
                    <div class="field-label">ç”Ÿå¹´æœˆæ—¥ / Birthdate</div>
                    <div class="field-value" id="preview-birthdate"></div>
                </div>
                <div class="data-field">
                    <div class="field-label">æ€§åˆ¥ / Gender</div>
                    <div class="field-value" id="preview-student-gender"></div>
                </div>
                <div class="data-field">
                    <div class="field-label">å­¦å¹´ / Grade</div>
                    <div class="field-value" id="preview-grade"></div>
                </div>
                <div class="data-field">
                    <div class="field-label">åœ¨ç±å­¦æ ¡ / Current School</div>
                    <div class="field-value" id="preview-school"></div>
                </div>
            </div>

            <div class="data-mapping">
                <div class="data-mapping-title">ğŸ‘¤ ä¿è­·è€…æƒ…å ± / Parent Information</div>
                <div class="data-field">
                    <div class="field-label">ä¿è­·è€…æ°å(ãƒ•ãƒªã‚¬ãƒŠ) / Parent Name (Kana)</div>
                    <div class="field-value" id="preview-parent-kana"></div>
                </div>
                <div class="data-field">
                    <div class="field-label">ä¿è­·è€…æ°å / Parent Name</div>
                    <div class="field-value" id="preview-parent-name"></div>
                </div>
                <div class="data-field">
                    <div class="field-label">æ€§åˆ¥ / Gender</div>
                    <div class="field-value" id="preview-parent-gender"></div>
                </div>
            </div>

            <div class="data-mapping">
                <div class="data-mapping-title">ğŸ“ é€£çµ¡å…ˆæƒ…å ± / Contact Information</div>
                <div class="data-field">
                    <div class="field-label">éƒµä¾¿ç•ªå· / Postal Code</div>
                    <div class="field-value" id="preview-postal"></div>
                </div>
                <div class="data-field">
                    <div class="field-label">ä½æ‰€ / Address</div>
                    <div class="field-value" id="preview-address"></div>
                </div>
                <div class="data-field">
                    <div class="field-label">æœ€å¯„ã‚Šé§… / Closest Station</div>
                    <div class="field-value" id="preview-station"></div>
                </div>
                <div class="data-field">
                    <div class="field-label">è‡ªå®…é›»è©± / Home Phone</div>
                    <div class="field-value" id="preview-home-phone"></div>
                </div>
                <div class="data-field">
                    <div class="field-label">æºå¸¯é›»è©± / Mobile Phone</div>
                    <div class="field-value" id="preview-mobile-phone"></div>
                </div>
                <div class="data-field">
                    <div class="field-label">ãƒ¡ãƒ¼ãƒ« / Email</div>
                    <div class="field-value" id="preview-email"></div>
                </div>
            </div>

            <div class="duplicate-actions">
                <button type="button" class="btn-cancel" id="closePdfPreview">
                    æˆ»ã‚‹ / Back
                </button>
                <button type="button" class="btn-confirm" id="generatePdf">
                    PDFã‚’é–‹ã / Open PDF
                </button>
            </div>
        </div>
    </div>

    <script>
        // Get location parameter from URL
        const urlParams = new URLSearchParams(window.location.search);
        const locationParam = urlParams.get('location');

        if (locationParam) {
            document.getElementById('campusValue').textContent = locationParam;
            document.getElementById('campus').value = locationParam;
        }

        // Store form data globally
        let formData = {};

        // Form validation rules
        const validationRules = {
            studentLastName: {
                required: true,
                message: 'ç”Ÿå¾’ã®å§“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ / Please enter student last name'
            },
            studentFirstName: {
                required: true,
                message: 'ç”Ÿå¾’ã®åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ / Please enter student first name'
            },
            studentLastNameKana: {
                required: true,
                pattern: /^[ã‚¡-ãƒ´ãƒ¼]+$/,
                message: 'å…¨è§’ã‚«ã‚¿ã‚«ãƒŠã§å…¥åŠ›ã—ã¦ãã ã•ã„ / Please enter in full-width katakana'
            },
            studentFirstNameKana: {
                required: true,
                pattern: /^[ã‚¡-ãƒ´ãƒ¼]+$/,
                message: 'å…¨è§’ã‚«ã‚¿ã‚«ãƒŠã§å…¥åŠ›ã—ã¦ãã ã•ã„ / Please enter in full-width katakana'
            },
            studentBirthdate: {
                required: true,
                message: 'ç”Ÿå¹´æœˆæ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ / Please enter date of birth'
            },
            studentGrade: {
                required: true,
                message: 'å­¦å¹´ã‚’é¸æŠã—ã¦ãã ã•ã„ / Please select grade'
            },
            parentLastName: {
                required: true,
                message: 'ä¿è­·è€…ã®å§“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ / Please enter parent last name'
            },
            parentFirstName: {
                required: true,
                message: 'ä¿è­·è€…ã®åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ / Please enter parent first name'
            },
            parentLastNameKana: {
                required: true,
                pattern: /^[ã‚¡-ãƒ´ãƒ¼]+$/,
                message: 'å…¨è§’ã‚«ã‚¿ã‚«ãƒŠã§å…¥åŠ›ã—ã¦ãã ã•ã„ / Please enter in full-width katakana'
            },
            parentFirstNameKana: {
                required: true,
                pattern: /^[ã‚¡-ãƒ´ãƒ¼]+$/,
                message: 'å…¨è§’ã‚«ã‚¿ã‚«ãƒŠã§å…¥åŠ›ã—ã¦ãã ã•ã„ / Please enter in full-width katakana'
            },
            postalCode: {
                required: true,
                pattern: /^\d{7}$/,
                message: '7æ¡ã®æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„ / Please enter 7 digits'
            },
            homePhone: {
                required: false,
                pattern: /^0\d{1,4}-\d{1,4}-\d{4}$/,
                message: 'é›»è©±ç•ªå·ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚ä¾‹: 03-1234-5678'
            },
            mobilePhone: {
                required: false,
                pattern: /^0\d{2,3}-\d{4}-\d{4}$/,
                message: 'é›»è©±ç•ªå·ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚ä¾‹: 090-1234-5678'
            },
            email: {
                required: false,
                pattern: /^[^\s@]+@[^\s@]+\.[^\s@]+$/,
                message: 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ / Invalid email format'
            }
        };

        // Validate field on blur
        function validateField(fieldName, value) {
            const rules = validationRules[fieldName];
            if (!rules) return true;

            if (rules.required && !value.trim()) {
                return { valid: false, message: rules.message };
            }

            if (value && rules.pattern && !rules.pattern.test(value)) {
                return { valid: false, message: rules.message };
            }

            return { valid: true };
        }

        // Add blur event listeners to all form fields
        Object.keys(validationRules).forEach(fieldName => {
            const field = document.getElementById(fieldName);
            if (field) {
                field.addEventListener('blur', function() {
                    const formGroup = this.closest('.form-group');
                    const errorMessage = formGroup.querySelector('.error-message');
                    const result = validateField(fieldName, this.value);

                    formGroup.classList.remove('error', 'valid');

                    if (!result.valid) {
                        formGroup.classList.add('error');
                        errorMessage.textContent = result.message;
                    } else if (this.value.trim()) {
                        formGroup.classList.add('valid');
                    }
                });
            }
        });

        // Form submission
        document.getElementById('interviewForm').addEventListener('submit', function(e) {
            e.preventDefault();

            // Validate all required fields
            let isValid = true;
            let firstErrorField = null;

            Object.keys(validationRules).forEach(fieldName => {
                const field = document.getElementById(fieldName);
                if (field) {
                    const formGroup = field.closest('.form-group');
                    const errorMessage = formGroup.querySelector('.error-message');
                    const result = validateField(fieldName, field.value);

                    formGroup.classList.remove('error', 'valid');

                    if (!result.valid) {
                        formGroup.classList.add('error');
                        errorMessage.textContent = result.message;
                        isValid = false;
                        if (!firstErrorField) firstErrorField = field;
                    } else if (field.value.trim()) {
                        formGroup.classList.add('valid');
                    }
                }
            });

            if (!isValid) {
                // Scroll to first error
                if (firstErrorField) {
                    firstErrorField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstErrorField.focus();
                }
                return;
            }

            // Capture form data
            const formDataObj = new FormData(this);
            formData = {
                campus: formDataObj.get('campus'),
                studentLastName: formDataObj.get('studentLastName'),
                studentFirstName: formDataObj.get('studentFirstName'),
                studentLastNameKana: formDataObj.get('studentLastNameKana'),
                studentFirstNameKana: formDataObj.get('studentFirstNameKana'),
                studentBirthdate: formDataObj.get('studentBirthdate'),
                studentGender: formDataObj.get('studentGender'),
                studentGrade: formDataObj.get('studentGrade'),
                studentSchoolType: formDataObj.get('studentSchoolType'),
                studentSchoolName: formDataObj.get('studentSchoolName'),
                parentLastName: formDataObj.get('parentLastName'),
                parentFirstName: formDataObj.get('parentFirstName'),
                parentLastNameKana: formDataObj.get('parentLastNameKana'),
                parentFirstNameKana: formDataObj.get('parentFirstNameKana'),
                parentGender: formDataObj.get('parentGender'),
                postalCode: formDataObj.get('postalCode'),
                prefecture: formDataObj.get('prefecture'),
                city: formDataObj.get('city'),
                street1: formDataObj.get('street1'),
                street2: formDataObj.get('street2'),
                closestStation: formDataObj.get('closestStation'),
                homePhone: formDataObj.get('homePhone'),
                mobilePhone: formDataObj.get('mobilePhone'),
                email: formDataObj.get('email')
            };

            // Show handoff modal
            const modal = document.getElementById('handoffModal');
            modal.classList.add('show');

            // In a real implementation, this would submit to Salesforce
            console.log('Form submitted successfully');
            console.log('Form data:', formData);
        });

        // Staff proceeds to create records and show success
        document.getElementById('proceedButton').addEventListener('click', function() {
            // Hide handoff modal
            document.getElementById('handoffModal').classList.remove('show');

            console.log('Creating student and parent records...');

            // In real implementation, this would:
            // 1. Submit to Salesforce to create Student, Parent, Relationship, and Enrollment Status records
            // 2. Handle any backend duplicate detection (optional)

            // Show success modal
            document.getElementById('successModal').classList.add('show');

            // After 2 seconds, show PDF format selection
            setTimeout(() => {
                document.getElementById('successModal').classList.remove('show');
                document.getElementById('pdfFormatModal').classList.add('show');
            }, 2000);
        });

        // PDF Format Selection Logic
        let selectedFormat = null;

        // Handle format card selection
        const formatCards = document.querySelectorAll('.format-card');
        formatCards.forEach(card => {
            card.addEventListener('click', function() {
                // Remove selection from all cards
                formatCards.forEach(c => c.classList.remove('selected'));

                // Select this card
                this.classList.add('selected');
                selectedFormat = this.dataset.format;

                // Enable confirm button
                document.getElementById('confirmPdfFormat').disabled = false;

                console.log('Selected PDF format:', selectedFormat);
            });
        });

        // Cancel PDF format selection
        document.getElementById('cancelPdfFormat').addEventListener('click', function() {
            document.getElementById('pdfFormatModal').classList.remove('show');

            // Reset selection
            selectedFormat = null;
            formatCards.forEach(c => c.classList.remove('selected'));
            document.getElementById('confirmPdfFormat').disabled = true;

            // Ask if they want to proceed to next interview
            setTimeout(() => {
                if (confirm('æ¬¡ã®é¢è«‡ã¸é€²ã¿ã¾ã™ã‹ï¼Ÿ/ Proceed to next interview?')) {
                    location.reload();
                }
            }, 300);
        });

        // Function to populate PDF preview with form data
        function populatePdfPreview() {
            // Gender mapping
            const genderMap = {
                'male': 'ç”·æ€§ / Male',
                'female': 'å¥³æ€§ / Female',
                '': 'æœªè¨˜å…¥ / Not specified'
            };

            // Grade mapping
            const gradeMap = {
                '1': 'å°å­¦1å¹´ / Grade 1',
                '2': 'å°å­¦2å¹´ / Grade 2',
                '3': 'å°å­¦3å¹´ / Grade 3',
                '4': 'å°å­¦4å¹´ / Grade 4',
                '5': 'å°å­¦5å¹´ / Grade 5',
                '6': 'å°å­¦6å¹´ / Grade 6',
                '7': 'ä¸­å­¦1å¹´ / Grade 7',
                '8': 'ä¸­å­¦2å¹´ / Grade 8',
                '9': 'ä¸­å­¦3å¹´ / Grade 9',
                '10': 'é«˜æ ¡1å¹´ / Grade 10',
                '11': 'é«˜æ ¡2å¹´ / Grade 11',
                '12': 'é«˜æ ¡3å¹´ / Grade 12',
                '': 'æœªè¨˜å…¥ / Not specified'
            };

            // School type mapping
            const schoolTypeMap = {
                'public': 'å…¬ç«‹ / Public',
                'private': 'ç§ç«‹ / Private',
                'national': 'å›½ç«‹ / National',
                '': 'æœªè¨˜å…¥ / Not specified'
            };

            // Prefecture mapping
            const prefectureMap = {
                'tokyo': 'æ±äº¬éƒ½ / Tokyo',
                'kanagawa': 'ç¥å¥ˆå·çœŒ / Kanagawa',
                'chiba': 'åƒè‘‰çœŒ / Chiba',
                'saitama': 'åŸ¼ç‰çœŒ / Saitama',
                'osaka': 'å¤§é˜ªåºœ / Osaka',
                'kyoto': 'äº¬éƒ½åºœ / Kyoto',
                '': ''
            };

            // Format birthdate
            function formatDate(dateString) {
                if (!dateString) return 'æœªè¨˜å…¥ / Not specified';
                const date = new Date(dateString);
                const year = date.getFullYear();
                const month = date.getMonth() + 1;
                const day = date.getDate();
                return `${year}å¹´${month}æœˆ${day}æ—¥ / ${year}/${month}/${day}`;
            }

            // Populate student information
            document.getElementById('preview-campus').textContent = formData.campus || 'æœªè¨˜å…¥';
            document.getElementById('preview-student-kana').textContent =
                `${formData.studentLastNameKana || ''} ${formData.studentFirstNameKana || ''}`.trim() || 'æœªè¨˜å…¥ / Not specified';
            document.getElementById('preview-student-name').textContent =
                `${formData.studentLastName || ''} ${formData.studentFirstName || ''}`.trim() || 'æœªè¨˜å…¥ / Not specified';
            document.getElementById('preview-birthdate').textContent = formatDate(formData.studentBirthdate);
            document.getElementById('preview-student-gender').textContent = genderMap[formData.studentGender || ''];
            document.getElementById('preview-grade').textContent = gradeMap[formData.studentGrade || ''];

            // Build school info
            let schoolInfo = '';
            if (formData.studentSchoolType) {
                schoolInfo += schoolTypeMap[formData.studentSchoolType];
            }
            if (formData.studentSchoolName) {
                schoolInfo += (schoolInfo ? ' - ' : '') + formData.studentSchoolName;
            }
            document.getElementById('preview-school').textContent = schoolInfo || 'æœªè¨˜å…¥ / Not specified';

            // Populate parent information
            document.getElementById('preview-parent-kana').textContent =
                `${formData.parentLastNameKana || ''} ${formData.parentFirstNameKana || ''}`.trim() || 'æœªè¨˜å…¥ / Not specified';
            document.getElementById('preview-parent-name').textContent =
                `${formData.parentLastName || ''} ${formData.parentFirstName || ''}`.trim() || 'æœªè¨˜å…¥ / Not specified';
            document.getElementById('preview-parent-gender').textContent = genderMap[formData.parentGender || ''];

            // Populate contact information
            document.getElementById('preview-postal').textContent = formData.postalCode || 'æœªè¨˜å…¥ / Not specified';

            // Build address
            let address = '';
            if (formData.prefecture) {
                address += prefectureMap[formData.prefecture] || formData.prefecture;
            }
            if (formData.city) {
                address += (address ? ' ' : '') + formData.city;
            }
            if (formData.street1) {
                address += (address ? ' ' : '') + formData.street1;
            }
            if (formData.street2) {
                address += (address ? ' ' : '') + formData.street2;
            }
            document.getElementById('preview-address').textContent = address || 'æœªè¨˜å…¥ / Not specified';

            document.getElementById('preview-station').textContent = formData.closestStation || 'æœªè¨˜å…¥ / Not specified';
            document.getElementById('preview-home-phone').textContent = formData.homePhone || 'æœªè¨˜å…¥ / Not specified';
            document.getElementById('preview-mobile-phone').textContent = formData.mobilePhone || 'æœªè¨˜å…¥ / Not specified';
            document.getElementById('preview-email').textContent = formData.email || 'æœªè¨˜å…¥ / Not specified';
        }

        // Confirm PDF format and show preview
        document.getElementById('confirmPdfFormat').addEventListener('click', function() {
            if (!selectedFormat) {
                alert('é¢è«‡ã‚«ãƒ«ãƒ†ã®å½¢å¼ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚\nPlease select a karte format.');
                return;
            }

            console.log('Showing PDF preview for format:', selectedFormat);

            // Populate preview with form data
            populatePdfPreview();

            // Hide format selection modal
            document.getElementById('pdfFormatModal').classList.remove('show');

            // Show preview modal
            document.getElementById('pdfPreviewModal').classList.add('show');
        });

        // Close PDF preview and go back to format selection
        document.getElementById('closePdfPreview').addEventListener('click', function() {
            document.getElementById('pdfPreviewModal').classList.remove('show');
            document.getElementById('pdfFormatModal').classList.add('show');
        });

        // Function to fill PDF with form data
        async function fillPdfWithData(pdfPath) {
            try {
                // Load the PDF
                const existingPdfBytes = await fetch(pdfPath).then(res => res.arrayBuffer());
                const pdfDoc = await PDFLib.PDFDocument.load(existingPdfBytes);

                // Register fontkit for custom font embedding
                pdfDoc.registerFontkit(fontkit);

                // Get the form
                const form = pdfDoc.getForm();
                const fields = form.getFields();

                console.log('PDF Form Fields:', fields.map(f => f.getName()));
                console.log('Number of form fields found:', fields.length);

                // Format date for PDF (Japanese format)
                const formatDateForPdf = (dateString) => {
                    if (!dateString) return '';
                    const date = new Date(dateString);
                    const year = date.getFullYear();
                    const month = date.getMonth() + 1;
                    const day = date.getDate();
                    return `${year}å¹´${month}æœˆ${day}æ—¥`;
                };

                // Check if PDF has form fields
                if (fields.length > 0) {
                    console.log('PDF has form fields. Filling them...');

                    // Helper function to safely set field value
                    const setFieldValue = (fieldName, value) => {
                        try {
                            const field = form.getTextField(fieldName);
                            if (field && value) {
                                field.setText(String(value));
                                console.log(`âœ“ Filled: ${fieldName} = ${value}`);
                            }
                        } catch (e) {
                            console.log(`âœ— Field ${fieldName} not found or not a text field`);
                        }
                    };

                    // Fill student information
                    setFieldValue('campus', formData.campus);
                    setFieldValue('studentLastName', formData.studentLastName);
                    setFieldValue('studentFirstName', formData.studentFirstName);
                    setFieldValue('studentLastNameKana', formData.studentLastNameKana);
                    setFieldValue('studentFirstNameKana', formData.studentFirstNameKana);
                    setFieldValue('studentName', `${formData.studentLastName} ${formData.studentFirstName}`);
                    setFieldValue('studentNameKana', `${formData.studentLastNameKana} ${formData.studentFirstNameKana}`);
                    setFieldValue('studentBirthdate', formatDateForPdf(formData.studentBirthdate));
                    setFieldValue('birthdate', formatDateForPdf(formData.studentBirthdate));
                    setFieldValue('studentGender', formData.studentGender);
                    setFieldValue('studentGrade', formData.studentGrade);
                    setFieldValue('grade', formData.studentGrade);
                    setFieldValue('studentSchoolType', formData.studentSchoolType);
                    setFieldValue('studentSchoolName', formData.studentSchoolName);
                    setFieldValue('schoolName', formData.studentSchoolName);

                    // Fill parent information
                    setFieldValue('parentLastName', formData.parentLastName);
                    setFieldValue('parentFirstName', formData.parentFirstName);
                    setFieldValue('parentLastNameKana', formData.parentLastNameKana);
                    setFieldValue('parentFirstNameKana', formData.parentFirstNameKana);
                    setFieldValue('parentName', `${formData.parentLastName} ${formData.parentFirstName}`);
                    setFieldValue('parentNameKana', `${formData.parentLastNameKana} ${formData.parentFirstNameKana}`);
                    setFieldValue('parentGender', formData.parentGender);

                    // Fill contact information
                    setFieldValue('postalCode', formData.postalCode);
                    setFieldValue('prefecture', formData.prefecture);
                    setFieldValue('city', formData.city);
                    setFieldValue('street1', formData.street1);
                    setFieldValue('street2', formData.street2);
                    setFieldValue('address', `${formData.prefecture || ''} ${formData.city || ''} ${formData.street1 || ''} ${formData.street2 || ''}`.trim());
                    setFieldValue('closestStation', formData.closestStation);
                    setFieldValue('homePhone', formData.homePhone);
                    setFieldValue('mobilePhone', formData.mobilePhone);
                    setFieldValue('email', formData.email);

                    // Flatten the form to make it non-editable
                    form.flatten();
                } else {
                    console.log('âš ï¸ PDF has no form fields. Opening PDF without modifications...');
                    // PDF will be opened as-is without any text overlay
                }

                // Save the PDF
                const pdfBytes = await pdfDoc.save();

                // Create a blob and download
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);

                // Open in new tab
                const newWindow = window.open(url, '_blank');

                if (!newWindow || newWindow.closed || typeof newWindow.closed === 'undefined') {
                    // Fallback: trigger download
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `interview_karte_${formData.studentLastName}_${formData.studentFirstName}.pdf`;
                    link.click();
                    console.log('âœ“ PDF download triggered');
                }

                return true;
            } catch (error) {
                console.error('âŒ Error filling PDF:', error);
                alert('PDFã®ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å…ƒã®PDFã‚’é–‹ãã¾ã™ã€‚\nError generating PDF. Opening original PDF.');
                // Fallback: open original PDF
                window.open(pdfPath, '_blank');
                return false;
            }
        }

        // Generate and open PDF
        document.getElementById('generatePdf').addEventListener('click', async function() {
            console.log('Generating PDF with format:', selectedFormat);

            // Map format to PDF file path
            const pdfFiles = {
                'elementary': 'elementry_ekarte_pdf_output.pdf',
                'middle': 'middle_school_ekarte_pdf_output.pdf',
                'high': 'high_school_ekarte_pdf_output.pdf'
            };

            const pdfPath = pdfFiles[selectedFormat];
            console.log('PDF Path:', pdfPath);

            if (!pdfPath) {
                alert('PDFãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚\nPDF file not found.');
                return;
            }

            // Fill and generate PDF
            const success = await fillPdfWithData(pdfPath);

            console.log('PDF generated:', success);

            // Close preview modal
            document.getElementById('pdfPreviewModal').classList.remove('show');

            // Reset everything and ask for next interview
            setTimeout(() => {
                if (confirm('PDFãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸï¼\nPDF generated successfully!\n\næ¬¡ã®é¢è«‡ã¸é€²ã¿ã¾ã™ã‹ï¼Ÿ/ Proceed to next interview?')) {
                    location.reload();
                } else {
                    // Reset selections for manual next interview
                    selectedFormat = null;
                    formatCards.forEach(c => c.classList.remove('selected'));
                    document.getElementById('confirmPdfFormat').disabled = true;
                }
            }, 500);
        });
    </script>
</body>
</html>
